# Stripe Implementation for Testing and Webhooks

## Overview
This project implements Stripe payment processing with checkout sessions, webhooks for order creation, and testing using Stripe CLI. The implementation handles secure payments, order management, and real-time updates.

## Key Components

### 1. Backend Setup (routes/stripe.js)

#### Checkout Session Creation
- **Endpoint**: `POST /api/V1/stripe/create-checkout-session`
- **Functionality**:
  - Creates Stripe customer with user email
  - Generates checkout session with product line items
  - Collects shipping address and phone number
  - Sets success/cancel URLs
  - Includes metadata for order data (userId, products, total, name, email)
  - Currency set to NGN for Nigerian Naira display

#### Webhook Handling
- **Endpoint**: `POST /api/V1/stripe/webhook`
- **Functionality**:
  - Verifies webhook signature using Stripe CLI secret
  - Processes `checkout.session.completed` events
  - Extracts order data from session metadata
  - Creates order in database with complete product details
  - Handles shipping and payment information

### 2. Frontend Integration

#### Cart Checkout (pages/Cart.jsx)
- Validates user authentication
- Sends cart data to backend for session creation
- Redirects to Stripe hosted checkout page
- Uses test card: `4242 4242 4242 4242`

#### Authentication (requestMethods.js)
- Axios instance with `withCredentials: true` for cookie-based auth
- Ensures JWT tokens are sent with requests

### 3. Database Models

#### Order Schema (models/order.model.js)
- Required fields: name, userId, products, total
- Optional: address, phone, email, status
- Status: 0 (pending), 1 (paid)

### 4. Testing with Stripe CLI

#### Setup Commands
```bash
# Install Stripe CLI
# Set up webhook forwarding
stripe listen --forward-to localhost:8000/api/V1/stripe/webhook

# The command provides webhook signing secret
# Add to .env: STRIPE_WEBHOOK_SECRET=whsec_...
```

#### Testing Commands
```bash
# Test checkout completion
stripe trigger checkout.session.completed

# Other useful triggers
stripe trigger payment_intent.succeeded
stripe trigger customer.created
```

### 5. Webhook Security

#### Signature Verification
- Uses `stripe.webhooks.constructEvent()` for signature validation
- Prevents unauthorized webhook calls
- Temporarily disabled for debugging, but should be enabled in production

#### Raw Body Handling
- Express raw body parser for webhook endpoint
- Required for Stripe signature verification

### 6. Order Creation Flow

1. **Frontend**: User clicks checkout → sends cart data
2. **Backend**: Creates Stripe session with metadata
3. **Stripe**: Hosts checkout page → user pays
4. **Webhook**: Receives completion event → creates order
5. **Frontend**: Redirects to /myorders → displays order

### 7. Metadata Structure
```json
{
  "userId": "user_id_string",
  "name": "user_name",
  "email": "user_email",
  "products": "[{\"_id\":\"id\",\"title\":\"name\",\"img\":\"url\",\"quantity\":1,\"price\":100}]",
  "total": "total_amount"
}
```

### 8. Error Handling

#### Common Issues Fixed
- **401 Unauthorized**: Added `withCredentials` for cookie auth
- **400 Webhook Errors**: Fixed signature verification and metadata
- **Order Not Found**: Ensured proper order creation with all required fields
- **Currency Display**: Changed from USD to NGN for local display

#### Debugging
- Added console logging for webhook events
- Order creation confirmation logs
- User order fetching logs

### 9. Environment Variables
```
STRIPE_SECRET_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...
CLIENT_URL=http://localhost:5173
```

### 10. Production Considerations

#### Security
- Enable webhook signature verification
- Use HTTPS for webhooks
- Validate all input data

#### Monitoring
- Log all webhook events
- Monitor failed payments
- Handle webhook retries

#### Scalability
- Process webhooks asynchronously
- Handle duplicate events
- Implement webhook queues if needed

## Testing Flow

1. Start backend: `npm run dev`
2. Start Stripe listener: `stripe listen --forward-to localhost:8000/api/V1/stripe/webhook`
3. Add product to cart in frontend
4. Complete checkout with test card
5. Verify order appears in MyAccount
6. Check backend logs for successful order creation

This implementation provides a complete Stripe integration with secure webhooks, proper order management, and comprehensive testing capabilities.