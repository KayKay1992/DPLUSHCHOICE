================================================================================

STOCK MANAGEMENT SYSTEM IMPLEMENTATION

Initial implementation: December 20, 2025
Documentation updated: December 22, 2025

Goal: Keep product inventory accurate by (1) preventing customers from adding more than available stock in the UI, and (2) enforcing stock validation + stock reduction on the backend when an order is created (both normal orders and Stripe Checkout orders).

================================================================================

1) DATA MODEL (MongoDB / Mongoose)

Product stock lives on the Product document:

- Backend/models/product.model.js
  - `stock: Number` (source of truth for inventory)
  - `inStock: Boolean` exists but the UI/logic mainly uses `stock`.

Orders store purchased items and quantities:

- Backend/models/order.model.js
  - `products: Array` (each item contains product id + quantity, etc.)
  - `total`, `address`, `phone`, `email`, `status`
  - `stripeSessionId` (added later for Stripe webhook idempotency)

================================================================================

2) FRONTEND UX (React)

The frontend uses `product.stock` to:

2.1 Product Listing Card
- frontend/src/components/Product.jsx
  - Calculates `isOutOfStock = (product.stock || 0) <= 0`
  - Disables +/- quantity controls when out of stock
  - Disables “Add to Cart” button when out of stock
  - Uses a small “loading” flag (`isAddingToCart`) to prevent multiple clicks

2.2 Product Details Page
- frontend/src/pages/ProductDetails.jsx
  - Displays “Out of Stock” vs “In Stock (X available)” using `product.stock`
  - Blocks add-to-cart if out of stock
  - Checks stock before adding to cart:
    - Reads existing quantity already in cart
    - Ensures `(existingCartQty + selectedQty) <= product.stock`

2.3 Cart Page (Quantity changes)
- frontend/src/pages/Cart.jsx
  - On +/- quantity changes, prevents increasing above `(product.stock || 50)`
  - Checkout sends cart payload to backend Stripe route
  - Note: There are still debug `console.log` statements in `handleCheckout`.

================================================================================

3) CART STATE MANAGEMENT (Redux Toolkit)

- frontend/src/redux/cartRedux.js
  - Stores carts per-user (`userCarts[userId]`) and a `guestCart`
  - `addProduct` INCREMENTS quantity if the item already exists in the cart
    - This is intentional in the current code (“increment quantity” behavior)
  - `updateProductQuantity` sets absolute quantity and recalculates totals

Important: The frontend tries to prevent exceeding stock, but the backend is the final authority.

================================================================================

4) BACKEND: NORMAL ORDER FLOW (Non-Stripe)

Route:
- Backend/routes/order.route.js
  - POST /api/V1/orders

Controller:
- Backend/controller/order.controller.js → `createOrder`

Stock enforcement happens here:

Step-by-step:
1. Receive `req.body.products` (each product includes `_id` or `id`, and `quantity`)
2. For each product:
   - Fetch Product from DB
   - Validate product exists
   - Validate `availableStock >= requestedQuantity`
   - Decrement stock using MongoDB `$inc: { stock: -requestedQuantity }`
3. After all items are validated + decremented, create and save the Order

Note about concurrency:
- `$inc` is atomic on a single document update.
- The validation and decrement are done in separate steps per product, so strict “no oversell under extreme concurrency” would require a conditional update or transaction. For typical usage this still keeps stock accurate.

================================================================================

5) BACKEND: STRIPE CHECKOUT FLOW

5.1 Create Checkout Session
- Backend/routes/stripe.js
  - POST /api/V1/stripe/create-checkout-session
  - Builds Stripe `line_items` from cart products (uses product.quantity)
  - Stores cart products inside Stripe metadata as JSON (`session.metadata.products`)
  - Collects shipping address and phone number

5.2 Webhook Endpoint Wiring
- Backend/app.js
  - Webhook route uses raw body first:
    `app.use('/api/V1/stripe/webhook', express.raw({ type: 'application/json' }))`
  - Then normal `express.json()` runs for other routes

5.3 Webhook Handler (checkout.session.completed)
- Backend/routes/stripe.js
  - POST /api/V1/stripe/webhook

Webhook step-by-step (current implementation):
1. Parse webhook event from the raw request body
2. On `checkout.session.completed`:
   - Extract `session.id` (Stripe Checkout Session id)
   - Parse products from `session.metadata.products`
   - Validate each product stock and decrement using `$inc` (same idea as normal orders)
   - Save a new Order with `stripeSessionId = session.id`

Important security note:
- The webhook currently parses JSON directly (there is a comment saying verification is temporarily disabled for testing).
- For production, Stripe signature verification should be enabled using the Stripe webhook secret.

================================================================================

6) CRITICAL BUG FIXES FOR STRIPE STOCK

6.1 Bug: Stock not reducing after Stripe orders
Cause:
- Stock reduction existed in the normal order controller, but Stripe orders were created in the webhook without stock logic.

Fix:
- Added stock validation + `$inc` stock decrement into the Stripe webhook flow.

6.2 Bug: Stock reduced multiple times (often “minus 3”) for one checkout
Cause:
- Stripe may deliver the same webhook event more than once.
- Without idempotency, the webhook repeated the stock decrement multiple times.

Fix (Idempotency):
- Backend/models/order.model.js
  - Added `stripeSessionId` with a unique sparse index
- Backend/models/stripeSession.model.js
  - Added a lock/status model with: `sessionId`, `status`, `processedAt`, `lastError`
- Backend/routes/stripe.js
  - Uses the lock + existing order check to ensure each `session.id` is processed once

================================================================================

7) FILES INVOLVED

Backend:
- Backend/models/product.model.js
- Backend/controller/order.controller.js
- Backend/routes/order.route.js
- Backend/app.js
- Backend/routes/stripe.js
- Backend/models/order.model.js
- Backend/models/stripeSession.model.js

Frontend:
- frontend/src/components/Product.jsx
- frontend/src/pages/ProductDetails.jsx
- frontend/src/redux/cartRedux.js
- frontend/src/pages/Cart.jsx

================================================================================

8) TESTING CHECKLIST

1. Product stock > 0
   - Can add to cart
   - Can increase cart quantity up to stock

2. Product stock = 0
   - UI shows “Out of Stock”
   - Add to cart disabled

3. Normal order (non-Stripe)
   - Place order → stock decreases by ordered quantity

4. Stripe order
   - Complete checkout → webhook creates order → stock decreases by ordered quantity
   - Retried webhook deliveries do NOT decrement stock again (idempotency)

================================================================================