
ADMIN ACCESS LOCK (ADMIN APP @ http://localhost:5175)

Goal
- Only admin users can access the admin app (localhost:5175).
- If a guest (not logged in) or a normal user tries to visit any admin URL, they must be redirected to the user homepage (localhost:5173).

How it was implemented (3 layers for reliability)

1) Server-side gate at the Vite dev server (strongest)
File: admin/vite.config.js

Why this layer exists
- Client-side guards can show a “flash” of admin UI or be bypassed if the HTML/JS bundle loads.
- This middleware blocks the admin app BEFORE the HTML is even served.

What it does
- A custom Vite plugin named "admin-auth-gate" is registered in the Vite plugins list.
- It adds a dev-server middleware (server.middlewares.use(...)).
- For every GET request that looks like a real page navigation (Accept header contains "text/html"), it:
	1) reads the browser cookies from req.headers.cookie
	2) calls the backend endpoint: GET {apiBase}/auth/me
		 - apiBase defaults to http://localhost:8000/api/V1
		 - it forwards cookies in the request so the backend can read the jwt cookie
	3) checks the returned user role
	4) if NOT logged in (401) OR role is not admin/staff/super-admin:
		 - responds with HTTP 302 redirect to clientUrl (frontend homepage)

Admin role check used
- Allowed roles: "admin", "staff", "super-admin" (also accepts "superadmin").

Environment variables used by this layer
- VITE_CLIENT_URL (defaults to http://localhost:5173)
- VITE_API_BASE_URL (optional, defaults to http://localhost:8000/api/V1)

Result
- Even if someone types http://localhost:5175/orders directly, the admin dev server will redirect them to http://localhost:5173 BEFORE any admin UI is delivered.


2) Client bootstrap gate before mounting React
File: admin/src/main.jsx

Why this layer exists
- Extra safety: even if the dev server serves the bundle (or in production build scenarios), we still prevent the React app from mounting for non-admins.

What it does
- Before calling createRoot(...).render(...), it calls:
	userRequest.get("/auth/me")
	where userRequest baseURL is http://localhost:8000/api/V1/ and withCredentials=true.
- If it fails (guest) or role is not admin/staff/super-admin:
	window.location.replace(clientUrl)
	and React is never mounted.


3) Router-level guard inside the admin React app
File: admin/src/App.jsx

Why this layer exists
- It protects route navigation inside the admin app.
- It ensures that all admin routes are behind the same check.

What it does
- Uses React Router v7 data router loader:
	loader: requireAdminLoader
- requireAdminLoader calls /auth/me.
- If role is not allowed (or request fails), it redirects to an internal route /__redirect.
- /__redirect renders a tiny component that performs a hard external navigation.

Files involved
- admin/src/App.jsx
	- loader: requireAdminLoader
	- route: /__redirect
- admin/src/pages/ExternalRedirect.jsx
	- window.location.replace(to)


BACKEND ENDPOINTS USED

1) Get current user (used by all gates)
Files:
- Backend/routes/auth.route.js
- Backend/controller/auth.controller.js

Endpoint
- GET /api/V1/auth/me

How it works
- It is protected by the "protect" middleware which reads the jwt cookie.
- If the cookie is missing/invalid, it returns 401.
- If valid, it returns the user object including role.


2) Logout endpoint (used by admin logout button)
Files:
- Backend/routes/auth.route.js
- Backend/controller/auth.controller.js

Endpoint
- GET /api/V1/auth/logout

How it works
- It clears the jwt cookie by setting it to an empty value with an expired date.


ADMIN LOGOUT BUTTON

File: admin/src/components/Menu.jsx

What was changed
- The “Logout” footer item is now a real button.
- On click it calls: userRequest.get("/auth/logout")
	(this clears the backend jwt cookie)
- Then it redirects to the user homepage:
	window.location.replace(VITE_CLIENT_URL or http://localhost:5173)
- It also disables the button while the logout request is in progress and changes the label to "Logging out...".


HOW TO TEST (recommended)

1) Start backend
- cd Backend
- npm run dev

2) Start admin
- cd admin
- npm run dev

3) Test as guest
- Open an Incognito/Private window (no cookies)
- Go to http://localhost:5175
- Expected: immediate redirect to http://localhost:5173

4) Test as admin
- Login as an admin user so the jwt cookie exists and role is admin/staff/super-admin
- Go to http://localhost:5175
- Expected: admin loads normally

5) Test logout
- Click Logout in the admin sidebar
- Expected: cookie is cleared and browser redirects to http://localhost:5173

